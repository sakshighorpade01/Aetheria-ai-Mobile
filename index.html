<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>AI-OS Mobile</title>

  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/assets/icon.png" type="image/png" />
  <link rel="apple-touch-icon" href="/assets/icon.png" />

  <!-- CSS -->
  <link rel="stylesheet" href="css/design-system.css" />
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/skeleton.css" />
  <link rel="stylesheet" href="css/chat-variables.css" />
  <link rel="stylesheet" href="css/chat-layout.css" />
  <link rel="stylesheet" href="css/chat-messages.css" />
  <link rel="stylesheet" href="css/chat-context.css" />
  <link rel="stylesheet" href="css/chat-input.css" />
  <link rel="stylesheet" href="css/message-actions.css" />
  <link rel="stylesheet" href="css/notifications.css" />
  <link rel="stylesheet" href="css/welcome-message.css" />
  <link rel="stylesheet" href="css/chat.css" />
  <link rel="stylesheet" href="css/to-do-list.css" />
  <link rel="stylesheet" href="css/artifact-ui.css" />
  <link rel="stylesheet" href="css/aios.css" />
  <link rel="stylesheet" href="css/mobile.css" />
  <link rel="stylesheet" href="css/modals.css" />
  <link rel="stylesheet" href="css/install-prompt.css" />
  
  <!-- Icon Libraries -->
  <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.6.0/uicons-thin-rounded/css/uicons-thin-rounded.css'>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" />

  <!-- JS Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>

<body class="dark-mode">
  <script>
    // Load theme preference immediately to prevent flash
    (function() {
      const savedTheme = localStorage.getItem('theme-preference');
      if (savedTheme) {
        document.body.classList.remove('light-mode', 'dark-mode');
        document.body.classList.add(savedTheme + '-mode');
      }
    })();
  </script>
  <div class="app-container">
    <!-- Top Bar (Simplified) -->
    <div class="top-bar">
      <div class="top-bar-action">
        <button id="new-chat-btn" class="top-bar-btn" aria-haspopup="true" aria-expanded="false">
          <i class="fi fi-tr-comment-medical"></i>
        </button>
        <div id="new-chat-menu" class="top-bar-dropdown hidden" role="menu">
          <button class="dropdown-item" data-dropdown-action="new-chat" role="menuitem">
            <i class="fi fi-tr-comment-medical"></i>
            <span>New chat</span>
          </button>
          <button class="dropdown-item" data-dropdown-action="new-task" role="menuitem">
            <i class="fi fi-tr-mail-plus-circle"></i>
            <span>New task</span>
          </button>
        </div>
      </div>
      <div class="top-bar-action">
        <button id="profile-menu-btn" class="top-bar-btn profile-btn" aria-haspopup="true" aria-expanded="false">
          <i class="fi fi-tr-circle-user" id="profile-icon-default"></i>
          <img id="profile-photo" class="profile-photo hidden" alt="Profile" />
        </button>
        <div id="profile-dropdown" class="profile-dropdown hidden" role="menu"></div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div id="chat-root"></div>
      <div class="welcome-container hidden">
        <div class="welcome-content">
          <h1 class="welcome-heading">Hello there</h1>
          <h2 class="welcome-secondary-heading">What can I do for you?</h2>
        </div>
      </div>
    </div>

    <!-- Bottom UI Area -->
    <div id="bottom-ui-container">
      <div class="floating-input-wrapper">
        <div id="floating-input-container" class="floating-input-container">
          <div id="attachment-strip" class="attachment-strip hidden" aria-live="polite">
            <div id="file-previews-container" class="attachments-scroll" role="list"></div>
          </div>
          <div class="input-field">
            <button id="attach-file-btn" class="input-action-btn circular-btn" aria-haspopup="true"
              aria-expanded="false"><i class="fa-regular fa-plus"></i></button>
            <div id="input-action-menu" class="input-action-menu hidden" role="menu" aria-label="Compose tools">
              <button type="button" class="input-action-menu-item active" data-menu-action="memory" role="menuitem"
                aria-pressed="true">
                <i class="fi fi-tr-brain"></i>
                <span>Memory</span>
              </button>
              <button type="button" class="input-action-menu-item" data-menu-action="attach" role="menuitem">
                <i class="fas fa-paperclip"></i>
                <span>Attach file</span>
              </button>
              <button type="button" class="input-action-menu-item" data-menu-action="sessions" role="menuitem">
                <i class="fi fi-tr-rectangle-vertical-history"></i>
                <span>Chats</span>
              </button>
            </div>
            <textarea id="floating-input" class="floating-input" placeholder="Ask anything..." rows="1"></textarea>
            <button id="send-message" class="input-action-btn circular-btn"><i class="fas fa-paper-plane"></i></button>
          </div>
        </div>
        <input type="file" id="file-input" style="display: none;" multiple />
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div id="to-do-list-root"></div>
  <div id="context-root"></div>
  <div class="notification-container"></div>

  <!-- PWA Install Prompt Banner -->
  <div id="install-prompt-banner" class="install-prompt-banner">
    <div class="install-prompt-content">
      <div class="install-prompt-icon">
        <img src="/assets/icon.png" alt="App Icon">
      </div>
      <div class="install-prompt-text">
        <h3 class="install-prompt-title">Install Aetheria AI</h3>
        <p class="install-prompt-subtitle">Get quick access from your home screen</p>
      </div>
      <div class="install-prompt-actions">
        <button id="install-prompt-install-btn" class="install-prompt-btn install-prompt-btn-primary">Install</button>
        <button id="install-prompt-dismiss-btn" class="install-prompt-btn install-prompt-btn-secondary">Not now</button>
      </div>
    </div>
  </div>
  <div id="file-preview-modal" class="modal-overlay hidden">
    <div class="preview-modal-content">
      <button class="close-preview-btn">×</button>
      <div id="preview-content-area"></div>
    </div>
  </div>

  <!-- Context Viewer Modal -->
  <div id="context-viewer-modal" class="modal-overlay hidden">
    <div class="context-viewer-panel">
      <div class="context-viewer-header">
        <h3>Message Context</h3>
        <button class="close-viewer-btn">×</button>
      </div>
      <div class="context-viewer-tabs">
        <button class="viewer-tab active" data-tab="sessions">
          <i class="fi fi-tr-rectangle-vertical-history"></i>
          <span>Sessions</span>
        </button>
        <button class="viewer-tab" data-tab="files">
          <i class="fas fa-paperclip"></i>
          <span>Files</span>
        </button>
      </div>
      <div class="context-viewer-content">
        <div class="viewer-tab-content active" id="sessions-content"></div>
        <div class="viewer-tab-content" id="files-content"></div>
      </div>
    </div>
  </div>

  <!-- ★★★ NEW: Dedicated Preview Modal for the Context Viewer ★★★ -->
  <div id="context-viewer-preview-modal" class="modal-overlay hidden">
    <div class="preview-modal-content">
      <button class="close-preview-btn">×</button>
      <div id="context-viewer-preview-area"></div>
    </div>
  </div>


  <!-- Application Logic -->
  <script type="module">
    import { AIOS } from './js/aios.js';
    import { chatModule } from './js/chat.js';
    import { ToDoList } from './js/to-do-list.js';
    import ContextHandler from './js/context-handler.js';
    import FileAttachmentHandler from './js/add-files.js';
    import { messageFormatter } from './js/message-formatter.js';
    import skeletonLoader from './js/skeleton-loader.js';

    // ★★★ NEW: Context Viewer Class (Expanded Logic) ★★★
    class ContextViewer {
      constructor() {
        this.modal = document.getElementById('context-viewer-modal');
        this.closeBtn = this.modal.querySelector('.close-viewer-btn');
        this.tabs = this.modal.querySelectorAll('.viewer-tab');
        this.sessionsContent = this.modal.querySelector('#sessions-content');
        this.filesContent = this.modal.querySelector('#files-content');
        this.tabContents = this.modal.querySelectorAll('.viewer-tab-content');
        this.currentContext = {};

        // --- NEW: Preview Modal Elements ---
        this.previewModal = document.getElementById('context-viewer-preview-modal');
        this.previewContentArea = this.previewModal.querySelector('#context-viewer-preview-area');
        this.closePreviewBtn = this.previewModal.querySelector('.close-preview-btn');

        this.bindEvents();
      }

      bindEvents() {
        this.closeBtn.addEventListener('click', () => this.hide());
        this.modal.addEventListener('click', (e) => {
          if (e.target === this.modal) this.hide();
        });

        this.tabs.forEach(tab => {
          tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
        });

        // --- Preview Modal Events ---
        this.closePreviewBtn.addEventListener('click', () => this.hidePreview());
        this.previewModal.addEventListener('click', (e) => {
          if (e.target === this.previewModal) this.hidePreview();
        });
      }

      show(contextData) {
        this.currentContext = contextData;
        const { files = [], sessions = [] } = contextData;

        this.renderSessions(sessions);
        this.renderFiles(files);

        this.tabs.forEach(tab => {
          const tabName = tab.dataset.tab;
          const hasContent = (tabName === 'files' && files.length > 0) || (tabName === 'sessions' && sessions.length > 0);
          tab.style.display = hasContent ? 'flex' : 'none';
        });

        if (sessions.length > 0) {
          this.switchTab('sessions');
        } else if (files.length > 0) {
          this.switchTab('files');
        } else {
          this.switchTab('sessions');
        }

        this.modal.classList.remove('hidden');
      }

      hide() {
        this.modal.classList.add('hidden');
      }

      switchTab(tabName) {
        this.tabs.forEach(tab => tab.classList.toggle('active', tab.dataset.tab === tabName));
        this.tabContents.forEach(content => content.classList.toggle('active', content.id === `${tabName}-content`));
      }

      renderFiles(files) {
        if (files.length === 0) {
          this.filesContent.innerHTML = '<div class="empty-state"><i class="fas fa-paperclip"></i><p>No files were attached.</p></div>';
          return;
        }

        this.filesContent.innerHTML = files.map((file, index) => {
          // Determine file icon based on type
          let iconClass = 'fa-file';
          if (file.type.startsWith('image/')) iconClass = 'fa-file-image';
          else if (file.type.startsWith('video/')) iconClass = 'fa-file-video';
          else if (file.type.startsWith('audio/')) iconClass = 'fa-file-audio';
          else if (file.type === 'application/pdf') iconClass = 'fa-file-pdf';
          else if (file.type.includes('word') || file.type.includes('document')) iconClass = 'fa-file-word';
          else if (file.type.includes('excel') || file.type.includes('spreadsheet')) iconClass = 'fa-file-excel';
          else if (file.type.includes('zip') || file.type.includes('archive')) iconClass = 'fa-file-archive';
          else if (file.name.match(/\.(js|jsx|ts|tsx|py|java|cpp|c|cs|php|rb|go|rs|html|css|json)$/i)) iconClass = 'fa-file-code';

          // Check if file has preview capability (either previewUrl or text content)
          const hasPreview = file.previewUrl || file.isText || file.content;

          return `
                    <div class="viewer-file-item">
                        <i class="fas ${iconClass}"></i>
                        <span class="item-name">${this.escapeHtml(file.name)}</span>
                        <div class="viewer-file-actions">
                            ${hasPreview ? `<button class="preview-context-file-btn" data-file-index="${index}" title="Preview File"><i class="fas fa-eye"></i></button>` : ''}
                        </div>
                    </div>
                `;
        }).join('');

        // Add click handlers for preview buttons
        this.filesContent.querySelectorAll('.preview-context-file-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const fileIndex = parseInt(btn.dataset.fileIndex);
            const file = files[fileIndex];
            this.showFilePreview(file);
          });
        });
      }

      renderSessions(sessions) {
        if (sessions.length === 0) {
          this.sessionsContent.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No sessions were used as context.</p></div>';
          return;
        }

        // Render session chips
        this.sessionsContent.innerHTML = sessions.map((session, index) => {
          // Support both session.runs and session.memory.runs structures
          const runs = session.runs || session.memory?.runs || [];

          // Get session title from first user message
          let sessionTitle = `Session ${index + 1}`;
          const topLevelRuns = runs.filter(run => !run.parent_run_id);

          if (topLevelRuns.length > 0) {
            const firstRun = topLevelRuns[0];
            const userInput = firstRun.input?.input_content || firstRun.content || '';

            if (userInput && userInput.trim()) {
              let messageContent = userInput;
              const marker = 'Current message:';
              const markerIndex = messageContent.lastIndexOf(marker);
              if (markerIndex !== -1) {
                messageContent = messageContent.substring(markerIndex + marker.length).trim();
              }

              // Get first line as title
              sessionTitle = messageContent.split('\n')[0].trim();
              if (sessionTitle.length > 50) {
                sessionTitle = sessionTitle.substring(0, 50) + '...';
              }
            }
          }

          return `
                    <div class="viewer-session-chip" data-session-index="${index}">
                        <span class="viewer-session-chip-title">${this.escapeHtml(sessionTitle)}</span>
                        <i class="fas fa-chevron-right viewer-session-chip-icon"></i>
                    </div>
                `;
        }).join('');

        // Add click handlers to chips
        this.sessionsContent.querySelectorAll('.viewer-session-chip').forEach(chip => {
          chip.addEventListener('click', (e) => {
            const sessionIndex = parseInt(chip.dataset.sessionIndex);
            this.showSessionDetail(sessions[sessionIndex], sessionIndex);
          });
        });
      }

      showSessionDetail(session, index) {
        // Support both session.runs and session.memory.runs structures
        const runs = session.runs || session.memory?.runs || [];
        const topLevelRuns = runs.filter(run => !run.parent_run_id);

        // Get session title
        let sessionTitle = `Session ${index + 1}`;
        if (topLevelRuns.length > 0) {
          const firstRun = topLevelRuns[0];
          const userInput = firstRun.input?.input_content || firstRun.content || '';

          if (userInput && userInput.trim()) {
            let messageContent = userInput;
            const marker = 'Current message:';
            const markerIndex = messageContent.lastIndexOf(marker);
            if (markerIndex !== -1) {
              messageContent = messageContent.substring(markerIndex + marker.length).trim();
            }
            sessionTitle = messageContent.split('\n')[0].trim();
            if (sessionTitle.length > 50) {
              sessionTitle = sessionTitle.substring(0, 50) + '...';
            }
          }
        }

        // Build conversation HTML
        const conversationHtml = topLevelRuns.map(run => {
          const userInput = run.input?.input_content || '';
          const assistantOutput = run.content || '';

          let html = '';

          // Add user message
          if (userInput && userInput.trim()) {
            let messageContent = userInput;
            const marker = 'Current message:';
            const markerIndex = messageContent.lastIndexOf(marker);
            if (markerIndex !== -1) {
              messageContent = messageContent.substring(markerIndex + marker.length).trim();
            }

            html += `
                        <div class="viewer-session-turn">
                            <div class="viewer-session-role">User</div>
                            <div class="viewer-session-content">${this.escapeHtml(messageContent)}</div>
                        </div>
                    `;
          }

          // Add assistant message
          if (assistantOutput && assistantOutput.trim()) {
            html += `
                        <div class="viewer-session-turn">
                            <div class="viewer-session-role">Assistant</div>
                            <div class="viewer-session-content">${this.escapeHtml(assistantOutput)}</div>
                        </div>
                    `;
          }

          // Legacy format support
          if (!userInput && !assistantOutput && run.role && run.content) {
            const isUser = run.role === 'user';
            let messageContent = run.content;

            if (isUser) {
              const marker = 'Current message:';
              const markerIndex = messageContent.lastIndexOf(marker);
              if (markerIndex !== -1) {
                messageContent = messageContent.substring(markerIndex + marker.length).trim();
              }
            }

            html += `
                        <div class="viewer-session-turn">
                            <div class="viewer-session-role">${isUser ? 'User' : 'Assistant'}</div>
                            <div class="viewer-session-content">${this.escapeHtml(messageContent)}</div>
                        </div>
                    `;
          }

          return html;
        }).join('');

        // Render expanded view
        this.sessionsContent.innerHTML = `
                <div class="viewer-session-expanded">
                    <div class="viewer-session-header">
                        <button class="viewer-session-back-btn">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="viewer-session-header-title">${this.escapeHtml(sessionTitle)}</div>
                    </div>
                    <div class="viewer-session-conversation">
                        ${conversationHtml || '<div class="empty-state"><i class="fas fa-inbox"></i><p>No conversation history.</p></div>'}
                    </div>
                </div>
            `;

        // Add back button handler
        const backBtn = this.sessionsContent.querySelector('.viewer-session-back-btn');
        backBtn.addEventListener('click', () => {
          this.renderSessions(this.currentContext.sessions);
        });
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // --- Preview Logic ---
      showFilePreview(file) {
        let contentHTML = '';
        const fileExt = file.name.split('.').pop().toLowerCase();

        // Handle text files
        if (file.isText || file.content) {
          const content = file.content || '';

          // Handle Markdown files
          if (fileExt === 'md' && typeof marked !== 'undefined') {
            const renderedMarkdown = marked.parse(content);
            contentHTML = `
                        <div class="preview-header">
                            <h3 class="preview-title">${this.escapeHtml(file.name)}</h3>
                        </div>
                        <div class="markdown-file-preview">
                            ${renderedMarkdown}
                        </div>
                    `;
          }
          // Handle CSV files
          else if (fileExt === 'csv') {
            const tableHTML = this.renderCSVTable(content);
            contentHTML = `
                        <div class="preview-header">
                            <h3 class="preview-title">${this.escapeHtml(file.name)}</h3>
                        </div>
                        <div class="csv-file-preview">
                            ${tableHTML}
                        </div>
                    `;
          }
          // Handle other text files
          else {
            const escapedContent = this.escapeHtml(content);
            contentHTML = `
                        <div class="preview-header">
                            <h3 class="preview-title">${this.escapeHtml(file.name)}</h3>
                        </div>
                        <div class="text-file-preview">
                            <pre><code>${escapedContent}</code></pre>
                        </div>
                    `;
          }
        }
        // Handle media files with previewUrl
        else if (file.previewUrl) {
          if (file.type.startsWith('image/')) {
            contentHTML = `
                        <div class="preview-header">
                            <h3 class="preview-title">${this.escapeHtml(file.name)}</h3>
                        </div>
                        <img src="${file.previewUrl}" alt="Preview of ${this.escapeHtml(file.name)}">
                    `;
          } else if (file.type.startsWith('video/')) {
            contentHTML = `<video src="${file.previewUrl}" controls autoplay></video>`;
          } else if (file.type.startsWith('audio/')) {
            contentHTML = `<audio src="${file.previewUrl}" controls autoplay></audio>`;
          } else if (file.type === 'application/pdf') {
            contentHTML = `<iframe class="pdf-preview" src="${file.previewUrl}"></iframe>`;
          } else {
            contentHTML = `<p>Preview is not available for this file type.</p>`;
          }
        }
        // Handle binary document files (docx, xlsx, etc.)
        else if (file.type.includes('word') || file.type.includes('excel') || file.type.includes('powerpoint') ||
          file.type.includes('document') || file.type.includes('spreadsheet') || file.type.includes('presentation')) {
          contentHTML = `
                    <div class="preview-unavailable">
                        <i class="fas fa-file-alt"></i>
                        <h3>${this.escapeHtml(file.name)}</h3>
                        <p>Preview is not available for ${fileExt.toUpperCase()} files.</p>
                        <p class="preview-hint">This file will be sent to the AI for processing.</p>
                    </div>
                `;
        }
        else {
          contentHTML = `
                    <div class="preview-unavailable">
                        <i class="fas fa-file"></i>
                        <h3>${this.escapeHtml(file.name)}</h3>
                        <p>Preview is not available for this file type.</p>
                    </div>
                `;
        }

        this.previewContentArea.innerHTML = contentHTML;
        this.previewModal.classList.remove('hidden');
      }

      renderCSVTable(csvContent) {
        const lines = csvContent.split('\n').filter(line => line.trim());
        if (lines.length === 0) return '<p>Empty CSV file</p>';

        // Parse CSV (simple parser, handles basic cases)
        const parseCSVLine = (line) => {
          const result = [];
          let current = '';
          let inQuotes = false;

          for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
              result.push(current.trim());
              current = '';
            } else {
              current += char;
            }
          }
          result.push(current.trim());
          return result;
        };

        const rows = lines.map(line => parseCSVLine(line));
        const headers = rows[0];
        const dataRows = rows.slice(1);

        // Limit to first 100 rows for performance
        const limitedRows = dataRows.slice(0, 100);
        const hasMore = dataRows.length > 100;

        let tableHTML = '<table class="csv-table"><thead><tr>';
        headers.forEach(header => {
          tableHTML += `<th>${this.escapeHtml(header)}</th>`;
        });
        tableHTML += '</tr></thead><tbody>';

        limitedRows.forEach(row => {
          tableHTML += '<tr>';
          row.forEach(cell => {
            tableHTML += `<td>${this.escapeHtml(cell)}</td>`;
          });
          tableHTML += '</tr>';
        });

        tableHTML += '</tbody></table>';

        if (hasMore) {
          tableHTML += `<p class="csv-note">Showing first 100 rows of ${dataRows.length} total rows</p>`;
        }

        return tableHTML;
      }

      hidePreview() {
        this.previewModal.classList.add('hidden');
        this.previewContentArea.innerHTML = '';
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const loadModuleHTML = async (name, containerId) => {
        try {
          const response = await fetch(`${name}.html`);
          if (!response.ok) throw new Error(`Failed to load ${name}.html: ${response.statusText}`);
          document.getElementById(containerId).innerHTML = await response.text();
        } catch (error) {
          console.error(`Error loading component ${name}:`, error);
        }
      };

      // Create aios-root container for profile dropdown content
      const aiosRoot = document.createElement('div');
      aiosRoot.id = 'aios-root';
      document.body.appendChild(aiosRoot);

      await Promise.all([
        loadModuleHTML('aios', 'aios-root'),
        loadModuleHTML('chat', 'context-root'),
        loadModuleHTML('to-do-list', 'to-do-list-root')
      ]);

      const chatContainer = document.getElementById('chat-container');
      if (chatContainer) {
        document.getElementById('chat-root').appendChild(chatContainer);
      }

      window.aios = new AIOS();
      await window.aios.init();

      console.log('[Init] Creating ContextHandler...');
      const contextHandler = new ContextHandler({ preloadDelay: 2500 });
      console.log('[Init] ContextHandler created, initializing elements...');
      contextHandler.initializeElements();
      console.log('[Init] Binding events...');
      contextHandler.bindEvents();
      console.log('[Init] Starting preload sessions...');
      contextHandler.preloadSessions();
      console.log('[Init] ContextHandler setup complete');

      const fileAttachmentHandler = new FileAttachmentHandler();

      console.log('[Init] Creating ContextViewer...');
      window.contextViewer = new ContextViewer();
      console.log('[Init] Setting global references...');
      window.chat = chatModule;
      window.contextHandler = contextHandler;
      window.fileAttachmentHandler = fileAttachmentHandler;
      console.log('[Init] Initializing chat module...');
      window.chat.init(contextHandler, fileAttachmentHandler, window.contextViewer);
      console.log('[Init] Chat module initialized');

      window.todo = new ToDoList();
      await window.todo.init();

      bindUIEvents();
      console.log("AI-OS Initialization Complete.");
    });

    function bindUIEvents() {
      const hamburgerBtn = document.getElementById('hamburger-btn');
      const newChatBtn = document.getElementById('new-chat-btn');
      const newChatMenu = document.getElementById('new-chat-menu');
      const attachMenuTrigger = document.getElementById('attach-file-btn');
      const inputActionMenu = document.getElementById('input-action-menu');
      const memoryMenuItem = inputActionMenu?.querySelector('[data-menu-action="memory"]');
      const sendBtn = document.getElementById('send-message');
      const input = document.getElementById('floating-input');

      const closeDropdowns = () => {
        newChatBtn?.setAttribute('aria-expanded', 'false');
        attachMenuTrigger?.setAttribute('aria-expanded', 'false');
        newChatMenu?.classList.add('hidden');
        inputActionMenu?.classList.add('hidden');
      };

      function closeFloatingWindows() {
        window.todo?.toggleWindow(false);
        window.contextHandler?.toggleWindow(false);
      }

      function closeAllModalsAndMenus() {
        closeFloatingWindows();
        closeDropdowns();
      }

      // Profile menu button handler is now in aios.js

      newChatBtn?.addEventListener('click', (event) => {
        event.stopPropagation();
        const isExpanded = newChatBtn.getAttribute('aria-expanded') === 'true';
        closeDropdowns();
        if (!isExpanded) {
          newChatBtn.setAttribute('aria-expanded', 'true');
          newChatMenu?.classList.remove('hidden');
        }
      });

      newChatMenu?.addEventListener('click', (event) => {
        event.stopPropagation();
        const item = event.target.closest('.dropdown-item');
        if (!item) return;

        const action = item.dataset.dropdownAction;
        closeDropdowns();
        if (action === 'new-chat') {
          window.chat?.clearChat();
        } else if (action === 'new-task') {
          closeFloatingWindows();
          window.todo?.toggleWindow(true);
        }
      });

      attachMenuTrigger?.addEventListener('click', (event) => {
        event.stopPropagation();
        const isExpanded = attachMenuTrigger.getAttribute('aria-expanded') === 'true';
        closeDropdowns();
        if (!isExpanded) {
          attachMenuTrigger.setAttribute('aria-expanded', 'true');
          inputActionMenu?.classList.remove('hidden');
        }
      });

      memoryMenuItem?.addEventListener('click', (event) => {
        event.stopPropagation();
        const current = window.chat?.getConfig?.().memory;
        window.chat?.setMemoryEnabled?.(!current);
        memoryMenuItem.classList.toggle('active', !current);
        memoryMenuItem.setAttribute('aria-pressed', (!current).toString());
      });

      inputActionMenu?.addEventListener('click', (event) => {
        event.stopPropagation();
        const item = event.target.closest('.input-action-menu-item');
        if (!item) return;

        const action = item.dataset.menuAction;
        console.log('[UI] Input action menu clicked:', action);

        if (action === 'attach') {
          closeDropdowns();
          window.fileAttachmentHandler?.openFilePicker?.();
        } else if (action === 'sessions') {
          console.log('[UI] Sessions button clicked, contextHandler exists:', !!window.contextHandler);
          closeDropdowns();
          closeFloatingWindows();
          if (window.contextHandler) {
            console.log('[UI] Calling toggleWindow(true)...');
            window.contextHandler.toggleWindow(true);
          } else {
            console.error('[UI] contextHandler not available!');
          }
        } else if (action === 'memory') {
          // handled above, but keep menu open for toggle feedback
        }
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('#bottom-ui-container')) {
          closeAllModalsAndMenus();
        }
        if (!e.target.closest('.top-bar-action')) {
          newChatBtn?.setAttribute('aria-expanded', 'false');
          newChatMenu?.classList.add('hidden');
        }
      });

      sendBtn?.addEventListener('click', () => {
        window.chat.handleSendMessage();
      });

      input?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          window.chat.handleSendMessage();
        }
      });

      input?.addEventListener('input', () => {
        // Close the plus button menu when user starts typing
        closeDropdowns();

        // Use requestAnimationFrame to batch layout changes and prevent jank
        requestAnimationFrame(() => {
          input.style.height = 'auto';
          input.style.height = `${input.scrollHeight}px`;
        });
      });

      input?.addEventListener('focus', () => {
        // Close the plus button menu when input is focused
        closeDropdowns();
      });
    }



    // Register Service Worker for PWA functionality
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('[PWA] Service Worker registered successfully:', registration.scope);

            // Check for updates periodically
            setInterval(() => {
              registration.update();
            }, 60000); // Check every minute

            // Handle service worker updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New service worker available
                  console.log('[PWA] New version available! Reloading...');
                  
                  // Auto-reload after 2 seconds to apply updates
                  setTimeout(() => {
                    window.location.reload();
                  }, 2000);
                }
              });
            });
          })
          .catch((error) => {
            console.error('[PWA] Service Worker registration failed:', error);
          });
      });
    }

    // Handle PWA install prompt - OUTSIDE service worker block
    let deferredPrompt;
    const installBanner = document.getElementById('install-prompt-banner');
    const installBtn = document.getElementById('install-prompt-install-btn');
    const dismissBtn = document.getElementById('install-prompt-dismiss-btn');

    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent the mini-infobar from appearing on mobile
      e.preventDefault();

      // Stash the event so it can be triggered later
      deferredPrompt = e;

      // Show the install banner after 1 second
      setTimeout(() => {
        if (installBanner) {
          installBanner.classList.add('show');
        }
      }, 1000);
    });

    // Install button click handler
    installBtn?.addEventListener('click', async () => {
      if (!deferredPrompt) {
        console.log('[PWA] No install prompt available');
        return;
      }

      // Hide the banner
      installBanner.classList.remove('show');

      // Show the install prompt
      deferredPrompt.prompt();

      // Wait for the user to respond to the prompt
      const { outcome } = await deferredPrompt.userChoice;

      if (outcome === 'accepted') {
        console.log('[PWA] User accepted the install');
      } else {
        console.log('[PWA] User dismissed the install');
      }

      // Clear the deferredPrompt
      deferredPrompt = null;
    });

    // Dismiss button click handler
    dismissBtn?.addEventListener('click', () => {
      installBanner.classList.remove('show');
    });

    // Track successful installation
    window.addEventListener('appinstalled', () => {
      if (installBanner) {
        installBanner.classList.remove('show');
      }
      deferredPrompt = null;
    });
  </script>
</body>

</html>